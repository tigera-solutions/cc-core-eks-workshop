# Module 3 - Zero-Trust Workload Access Control with Namespace Isolation Recommendation

One of the best ways to make your Kubernetes cluster more secure is to use network policy to isolate namespaces. This means that you only allow the communication between namespaces that is absolutely necessary, and you block everything else. This helps to reduce the risk of an attacker moving from one part of your cluster to another if they manage to get in.

Calico Cloud makes it simple for platform operators to set up namespace isolation. Calico Cloud looks at the flow logs generated by your workloads. Then, it automatically suggests and sets up policies for each namespace. These policies can be used to isolate your namespaces from each other.

During this workshop, we will use the `Cat Facts Application` as an example to work on. In this module, we will learn how to use Calico to recommend and set up network policies to control access to and from a namespace.  Once the application is deployed, we will enable the policy recommandations and then review and activate the policies.

## Enable policy recommendations

1. In the left navbar in Manager UI, click **Policies, Recommendations**.
2. On the opt-in page, click Enable Policy Recommendations.

   The Policy Recommendations board is automatically displayed.

   ![enable-policy-recommendation](https://github.com/tigera-solutions/cc-aks-zero-trust-workshop/assets/104035488/56a8a8b3-654d-40f8-9e04-160ff1439efd)

> [!NOTE]
>
> - A policy recommendation is generated for every namespace in your cluster (unless namespaces are filtered out by an Admin using the selector in the PolicyRecommendationScope resource).
> - Flow logs are continuously monitored for policy recommendations.
> - Recommended policies are continuously updated until you Add to policy board or Dismiss policy using the Actions menu.
> - Policy recommendations are created as staged network policies so you can safely observe the traffic before enforcing them.
> - Traffic originating from the recommended policy's namespace is used to generate egress rules, and traffic destined for the namespace is used to define ingress rules.
> - To stop policy recommendations from being processed and updated for a namespace, click the Action menu, Dismiss policy.

## The Zero Trust approach

A global default deny policy ensures that unwanted traffic (ingress and egress) is denied by default. Pods without policy (or incorrect policy) are not allowed traffic until the appropriate network policy is defined. Although the staging policy tool will help you find the incorrect or the missing policy, a global deny policy helps mitigate other lateral malicious attacks.

By default, all traffic is allowed between the pods in a cluster. Let's start by testing connectivity between application components and across application stacks. All of these tests should succeed as there are no policies in place.

We recommend creating a global default deny policy after you complete reviewing the policy for the traffic you want to allow. Use the stage policy feature to get your allowed traffic working as expected, then lock down the cluster to block unwanted traffic.

1. Create a staged global default-deny policy. It will show all the traffic that would be blocked if it were enforced.

   - Go to the `Policies Board`
   - On the bottom of the tier box `default` click on `Add Policy`
     - In the `Create Policy` page enter the policy name: `default-deny`
     - On the `Applies To` session, click `Add Namespace Selector`
       First, lets apply only to the required namespaces:
       - Select Key... `kubernetes.io/metadata.name`
       - =
       - Select Value... `catfacts`
       - OR
       - Select Key... `kubernetes.io/metadata.name`
       - Select Value... `catfacts`
     - On the field `Type` select both checkboxes: Ingress and Egress.
     - You are done. Click `Stage` on the top-right of your page.

   The staged policy does not affect the traffic directly but allows you to view the policy impact if it were to be enforced. You can see the denied traffic in the staged policy.

## Review and activate policy recommendations

1. Review the policy recommendations

   After a few minutes, you will be able to see the policy recommendation. Take a minute to review the rules being suggested and ensure they align with your intentions.

   ![policy-recommendation](https://github.com/tigera-solutions/cc-aks-zero-trust-workshop/assets/104035488/ccefd3ac-9c4e-4934-882b-b476e5057de9)

2. Activate policy recommendations
  
   From the Policy Recommendation board, select a policy recommendation (or bulk select) and select, `Add to policy board`. You can now view the active policies in the Policies Board. In the left navbar, click `Policies`.

   ![policy-recommendation](https://github.com/tigera-solutions/cc-aks-zero-trust-workshop/assets/104035488/088112b2-ea72-4e8b-bc72-769e855a8828)

3. View the active policies in Policy Recommendations.

   Click on the `Active` tab in `Policy Recommendations`. Active policies were recommendations that were moved to the policy board.

   ![active-policies](https://github.com/tigera-solutions/cc-aks-zero-trust-workshop/assets/104035488/11782de7-a26a-4d3e-9e24-a800b77592d1)

   Policy recommendations are added to the `namespace-isolation` tier. Note the following:

   - Staged network policy recommendations work like any other staged network policy.
   - You cannot move recommended staged policies in the `namespace-isolation` tier.
   - The name of the `namespace-isolation` tier is fixed and cannot be changed

   You are now ready to observe traffic flows in Policies board to verify that the policy is authorizing traffic as expected. When a policy works as expected, you can safely enforce it.

## Visualize denied staged traffic via Kibana Log Explorer

1. To explore the flows that would be denied by the staged policies, we can explore the logs better in Kibana. This can be accessed by clicking on ```Logs``` in the left menu, this takes us to the Kibana dashboard in a new browser tab.

    ![Logs_menu](https://github.com/tigera-solutions/cc-eks-observability-workshop/assets/117195889/8c20ddf6-f0bc-4325-a81d-71af8370d69e)

2. From the hamburger menu on the top left corner, click ```Discover```.

   ![kibana_discover](https://github.com/tigera-solutions/cc-eks-observability-workshop/assets/117195889/85a5702b-e210-4c4f-a784-ec5a66d7f63c)

3. From the left menu bar just below Add filter, ensure tigera_secure_ee_flows* index is selected and then click on the plus sign next to the following flow logs metadata to filter through the metadata. Make sure to filter as per the order listed below to have an organized and clear view of the filtered information. Change the filter time range to ```last 15 minutes```.

    ```bash
    source_namespace
    source_name_aggr
    dest_namespace
    dest_name_aggr
    dest_port
    reporter
    policies
    ```

    ![add_field](https://github.com/tigera-solutions/cc-eks-observability-workshop/assets/117195889/7c5e974e-e10b-42f9-8809-fbe43540adf2)

4. Once the above filter is implemented, you should see a page similar to the following:
    ![filtered_logs](https://github.com/tigera-solutions/cc-eks-observability-workshop/assets/117195889/c49e7ff9-1b31-4326-b161-2620ad4e7d41)

5. Type the following in the search bar of the ```Discover``` page, this will look for any traffic that would be getting denied by the staged policies we implemented:

    ```policies:{ all_policies: *default.staged**deny*  }```

    If we see any matches on traffic that our staged policies would be denying, let's try to understand what flows are being blocked, whether they are legitimate traffic that instead needs to be allowed, and make the required changes to the policy.

---

[:arrow_right: Module 4 - Workload Isolation with Microsegmentation](module-4-multi-ns-wkld-secure.md)  

[:arrow_left: Module 2 - Observe traffic flows in Calico Cloud](module-2-observe-traffic.md)  
[:leftwards_arrow_with_hook: Back to Main](../README.md)  
